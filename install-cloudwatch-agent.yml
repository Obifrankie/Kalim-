---
- name: Install CloudWatch Agent
  hosts: all
  become: yes

  tasks:
    - name: Download CloudWatch Agent package
      get_url:
        url: "https://s3.amazonaws.com/amazoncloudwatch-agent/ubuntu/amd64/latest/amazon-cloudwatch-agent.deb"
        dest: "/tmp/amazon-cloudwatch-agent.deb"

    - name: Install CloudWatch Agent package
      apt:
        deb: "/tmp/amazon-cloudwatch-agent.deb"
        state: present

    - name: Create CloudWatch Agent configuration directory
      file:
        path: /opt/aws/amazon-cloudwatch-agent/etc
        state: directory
        mode: '0755'

    - name: Copy CloudWatch Agent configuration file
      copy:
        dest: /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
        content: |
          {
            "agent": {
              "metrics_collection_interval": 60,
              "run_as_user": "cwagent"
            },
            "metrics": {
              "namespace": "EC2InstanceMetrics",
              "append_dimensions": {
                "InstanceId": "${aws:InstanceId}",
                "InstanceType": "${aws:InstanceType}"
              },
              "aggregation_dimensions" : [["InstanceId"]],
              "metrics_collected": {
                "disk": {
                  "measurement": [
                    {"name": "disk_used_percent", "unit": "Percent"}
                  ],
                  "metrics_collection_interval": 60,
                  "resources": ["*"]
                },
                "mem": {
                  "measurement": [
                    {"name": "mem_used_percent", "unit": "Percent"}
                  ],
                  "metrics_collection_interval": 60
                }
              }
            }
          }

    - name: Start CloudWatch Agent
      command: /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a start -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json